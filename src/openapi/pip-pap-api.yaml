openapi: 3.0.3
info:
  title: Policy Information Point und Policy Administration Point API
  description:  This service is part of the Zero Trust
                Telematikinfrastruktur and implements download
                endpoints for OPA compatible PIP and PAP bundles.
                Open Policy Agents of the Telematikinfrastruktur can
                retrieve policy bundles for their application and
                version. The bundles are signed by the central
                administrative OPA instance.
  version: 1.0.0
tags:
  - name: PIP
    description: Policy Information Point
  - name: PAP
    description: Policy Administration Point
servers:
  - url: https://localhost:8080
    description: Local development server
  - url: https://pip-pap.ti-dienste.de
    description: Production server
paths:
  /pip-bundles/{application}/{version}/bundle.tar.gz:
    get:
      summary: Retrieve a signed PIP OPA bundle
      description: Retrieve a signed PIP OPA bundle for the given application and version.
      parameters:
        - name: application
          in: path
          description: Application name
          required: true
          schema:
            type: string
        - name: version
          in: path
          description: Version of the application
          required: true
          schema:
            type: string  
        - in: header
          name: If-None-Match
          description: The revision of the last retrieved policy bundle (ETag header)
          schema:
            type: string
            description: The revision of the last retrieved policy bundle
      # Define response structure for policy bundle retrieved from PIP
      responses:
        '200':
          description: OK
          headers:
            ETag: 
              schema:
                type: string
                description: The revision of the policy bundle.
                             Services must check the If-None-Match header and
                             reply with HTTP 304 Not Modified if the bundle
                             has not changed since the last update.
          content:
            application/gzip:
              schema:
                type: string
                format: binary
                description: The signed OPA PIP bundle
        '304':
          description: Not Modified
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: The error message
                example:
                  error: The requested bundle does not exist.

  /pap-bundles/{application}/{version}/bundle.tar.gz:
    get:
      summary: Retrieve a signed PAP OPA bundle
      description: Retrieve a signed PAP OPA bundle for the given application and version.
      parameters:
        - name: application
          in: path
          description: Application name
          required: true
          schema:
            type: string
        - name: version
          in: path
          description: Version of the application
          required: true
          schema:
            type: string
        - in: header
          name: If-None-Match
          description: The revision of the last retrieved policy bundle (ETag header)
          schema:
            type: string
            description: The revision of the last retrieved policy bundle
      # Define response structure for policy bundle retrieved from PAP
      responses:
        '200':
          description: OK
          headers:
            ETag: 
              schema:
                type: string
                description: The revision of the policy bundle.
                             Services must check the If-None-Match header and
                             reply with HTTP 304 Not Modified if the bundle
                             has not changed since the last update.
          content:
            application/gzip:
              schema:
                type: string
                format: binary
                description: The signed OPA PAP bundle
        '304':
          description: Not Modified
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: The error message
                example:
                  error: The requested bundle does not exist.
