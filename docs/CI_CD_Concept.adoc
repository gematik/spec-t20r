ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
:source-style: listing
endif::[]

ifndef::env-github[:source-style: source]

:imagesdir: /images/

= CI/CD Konzept für den Zero Trust Cluster

image::gematik_logo.svg[gematik,width="70%"]

== Einleitung

Die Zero Trust Komponenten PEP und PDP sind in einem Kubernetes (K8s) Cluster implementiert Der K8s Cluster wird im folgenden als Zero Trust (ZT) Cluster bezeichnet. Die Fachdienste der TI 2.0 nutzen diesen ZT Cluster, als Sicherheitsleistung, sodass nur berechtigte Nutzer mit zugelassenen Apps auf die Ressourcen der Fachdienste zugreifen können. Um die Sicherheit und Zuverlässigkeit des ZT Clusters zu gewährleisten, ist ein durchdachtes CI/CD-Konzept erforderlich. Dieses Konzept umfasst die Strukturierung der Repositories, die Implementierung von Tests, Build- und Bereitstellungspipelines, Sicherheitsmaßnahmen, Überwachung und Compliance-Aspekte.

Die Bereitstellung der Cluster-Komponenten PEP und PDP erfolgt über durch die gematik oder einen von der gematik beauftragten Dienstleister. Für die Entwicklung und den Test ist eine CI Pipeline erforderlich, die die automatisierte Bereitstellung und Tests des ZT Clusters ermöglicht. Die Pipeline sollte auch Sicherheitstests, wie Schwachstellenscans und Compliance-Checks, enthalten. 

Die automatische Aktualisierung des ZT Cluster erfolgt über einen CD Prozess. Dazu gehören das Update von PEP und PDP (nach erfolgreichem Durchlauf der CI Pipeline), die Aktualisierung der ZT Cluster-Konfiguration sowie die Aktualisierung der Policies und Daten für den PDP. Der CD Prozess liegt in der Verantwortung der gematik.

Die Sicherheit des ZT Clusters sollte durch Zero Trust Prinzipien, Zugriffskontrollen, Sicherheits-Scans und Netzwerkrichtlinien gewährleistet werden. Die Überwachung und das Logging des ZT Clusters sind ebenfalls wichtige Aspekte, um die Leistung und Sicherheit zu gewährleisten. Compliance- und Audit-Anforderungen sollten ebenfalls berücksichtigt werden, um sicherzustellen, dass der ZT Cluster den Anforderungen der gematik entspricht.

== CI/CD Konzept

Die Bereitstellung der ZT Cluster-Komponenten PEP und PDP erfolgt über SourceK8s-Infrastruktur-Code, der in einem GitHub Repository gespeichert ist. Die ZT Cluster-Konfiguration wird in einem separaten GitHub Repository gespeichert. Dadurch ist eine Trennung der Verantwortlichkeiten von Entwicklung (CI) und Betrieb (CD) des ZT Clusters möglich. Ein weiteres GitHub Repository enthält die Policies und Daten, die der PDP vom PIP und PAP Service bezieht. 
Die CI Pipeline wird durch GitHub Actions ausgelöst und überwacht. Sie beinhaltet automatisierte Tests, Builds und Bereitstellungsschritte.
Der ZT Cluster wird in der Infrastruktur des Anbieters des Fachdienstes betrieben. Der Anbieter des Fachdienstes ist für den Betrieb des ZT Clusters verantwortlich. Die gematik hat keinen direkten Zugriff auf den ZT Cluster. Die gematik erhält Zugriff auf die Logs und Metriken des ZT Clusters, um die Leistung und Sicherheit zu überwachen.

Es gibt zwei Möglichkeiten, wie der ZT Cluster betrieben werden kann.

. Betrieb in Verantwortung des Fachdienst-Anbieters:
Der Fachdienst-Anbieter stellt sicher, dass der ZT Cluster den Sicherheitsstandards der gematik entspricht und die Anforderungen des Fachdienstes erfüllt. Diese Variante setzt voraus, dass der Anbieter die notwendigen Ressourcen und Expertise für den Betrieb des ZT Clusters hat und dass die gematik dem Anbieter vertraut. Die gematik kann von sich aus nicht sicherstellen, dass der ZT Cluster den Anforderungen entspricht.

. Betrieb in Verantwortung der gematik:
Die gematik stellt sicher, dass der ZT Cluster den Sicherheitsstandards entspricht und die Anforderungen des Fachdienstes erfüllt. Diese Variante setzt voraus, dass die gematik die notwendigen Ressourcen und Expertise für den Betrieb des ZT Clusters hat.

=== CI Pipeline

Die Stationen der CI Pipeline werden durch GitHub Actions ausgelöst und überwacht. Folgende Schrittesind vorgesehen:

. ZT Cluster Development: Implementierung von Änderungen an PEP und PDP, einschließlich neuer Funktionen, Bugfixes und Sicherheitsupdates. Erstellung von Container-Images für die Komponenten des ZT Clusters mit Docker. Erstellung von Kubernetes-Manifesten für die ZT Cluster Komponenten (Infrastructure as Code). Überprüfung der Änderungen durch Code-Reviews.
. Quality Gate Dev: Automatisierte Tests für den Anwendungscode, einschließlich Unittests.
. Quality Gate ZT Cluster Integration: Tests der Kubernetes-Infrastruktur, inklusive Sicherheitstests und Lasttests.
. Quality Gate Referenz-Integration: End-to-End-Tests mit den Referenz-Integrations-Komponenten, inklusive Sicherheitstests und Lasttests. 
. Build: Erstellung von Container-Images für die Komponenten des ZT Clusters mit Docker. Multistage-Builds, um sicherzustellen, dass nur die notwendigen Abhängigkeiten im finalen Image vorhanden sind. 
. ZT Cluster PU und RU: Signierung und Überprüfung von Container-Images, um die Integrität zu gewährleisten. Label Version, reference und latest.

=== CD Prozess

Der CD Prozess knüpft an das Ergebnis des CI Prozesses an. Die ZT Cluster Manifeste und Terraform Scripte werden über git Submodule direkt in das GitHub CD Repository integriert.

. TI 2.0 Dienst ZT Cluster Entwicklung: Automatisierung der Bereitstellung des TI 2.0 dienst-spezifischem K8s-Cluster basierend auf den Änderungen im CI Repository.
. Quality Gate Dev: Automatisierte Tests des dienst-spezifischem K8s-Clusters
. Quality Gate TI 2.0 Dienst ZT Cluster Integration: Automatische Integrations-Tests mit den dienst-spezifischen Referenz-Komponenten der RU
. TI 2.0 Dienst ZT Cluster RU: Der dienstspezifische Cluster ist damit vollständig getestet und wird dem Betreiber für seine Tests bereitgestellt.
. Quality Gate TI 2.0 Dienst ZT Cluster Integration: Der Betreiber des TI 2.0 Dienstes führt seine Tests aus.
. TI 2.0 Dienst ZT Cluster PU: Der dienstspezifische ZT Cluster steht für den Einsatz in der PU bereit.

image::CI_CD_Concept/ZT_CI-CD-Pipeline.png[Zero Trust CI/CP Pipeline,width="70%"]


== Rollen und Verantwortlichkeiten

Im CI/CD Prozess sind verschiedene Rollen und Verantwortlichkeiten definiert. Diese umfassen:

|===
|Rolle|Beschreibung

|ZT Cluster Entwickler
|Entwickelt den PEP

Erzeugt die K8s yaml Dateien für den ZT Cluster

Steuert und Überwacht den Durchlauf des CI Prozesses inkl. Quality Gates

Erstellt eine Installationsanleitung für den ZT Cluster inkl. Systemvoraussetzungen

Leistet Support für die entwickelte SW und die yaml Dateien für den ZT Cluster

|ZT Cluster Anbieter
|Ist verantwortlich für den CI Prozess

Leistet Support für den ZT Cluster

|ZT Cluster Betreiber
|Ist verantwortlich für den Betrieb des ZT Clusters

Ist verantwortlich für den CD Prozess inkl. Quality Gates

|PIP und PAP Security Entwickler
|Ist verantwortlich für die Bereitstellung der Policies und Daten, die über den PIP und PAP Service an den PDP verteilt werden.

Steuert und Überwacht den Durchlauf des CI Prozesses inkl. Quality Gates

|PIP und PAP Security Manager
|Ist verantwortlich für den CI Prozess

Leistet Support für den ZT Cluster

|PIP und PAP Service Anbieter
|Ist verantwortlich für die Entwicklung und den Betrieb des PIP und PAP Service.

Ist verantwortlich für den CD Prozess inkl. Quality Gates

|===

== Ablauf

Es gibt einen CI/CD Prozess für den ZT Cluster und einen CI/CD Prozess für die Policies und Daten des PIP und PAP Service.

=== CI Prozess ZT Cluster

In diesem Prozess werden Änderungen am ZT Cluster entwickelt und nach erfolgreichem Durchlauf der Quality Gates in einen produktionsreifen Zustand gebracht.

==== Konzeption

Die Konzeption erfolgt durch die gematik. Das Ergebnis ist eine geänderte ZT Spezifikation.

==== Implementierung



==== Integration dev-test

==== Integration qs-test

==== Rollout ref

==== Rollout prod

=== CD Prozess ZT Cluster

==== Deployment ref

==== Deployment prod

=== CI Prozess Policies und Daten für PIP und PAP Service

==== Konzeption

==== Implementierung

==== Integration dev-test

==== Integration qs-test

==== Rollout ref

==== Rollout prod

=== CD Prozess Policies und Daten für PIP und PAP Service

==== Deployment ref

==== Deployment prod


== Risiken beim Betrieb des ZT Clusters

Die Bereitstellung und der Betrieb des ZT Clusters sind mit verschiedenen Risiken verbunden. Dazu gehören:

. Sicherheitsrisiken: Schwachstellen im Code, in der Konfiguration des ZT Clusters oder in den Policies und Daten können zu Sicherheitslücken führen, die von Angreifern ausgenutzt werden können.
. Datenschutzrisiken: Verstöße gegen den Datenschutz oder die Privatsphäre der Nutzer können zu rechtlichen Konsequenzen führen und das Vertrauen der Nutzer gefährden.
. Betriebsrisiken: Ausfälle oder Störungen im Betrieb des ZT Clusters können zu Beeinträchtigungen der Fachdienste führen und die Verfügbarkeit der Ressourcen beeinträchtigen.
. Partnerschaftsrisiken: Abhängigkeit von externen Dienstleistern oder Partnern für den Betrieb des ZT Clusters kann zu Risiken in Bezug auf Vertraulichkeit, Verfügbarkeit und Integrität der Daten führen.
. Managementrisiken: Fehlende Dokumentation, Schulung und Überwachung können zu Managementproblemen führen und die Effizienz des Betriebs beeinträchtigen.
. Budgetrisiken: Unvorhergesehene Kosten für den Betrieb des ZT Clusters können das Budget des Fachdienstes belasten und die Rentabilität des Projekts gefährden.
. Reputationsrisiken: Sicherheitsvorfälle oder Betriebsstörungen des ZT Clusters können das Ansehen des Fachdienstes und der gematik beeinträchtigen und das Vertrauen der Nutzer gefährden.
. Technologierisiken: Veraltete Technologien oder fehlende Updates können die Leistung und Sicherheit des ZT Clusters beeinträchtigen und die Skalierbarkeit des Systems einschränken.
. Innovationsrisiken: Fehlende Innovation und Weiterentwicklung des ZT Clusters können die Wettbewerbsfähigkeit des Fachdienstes beeinträchtigen und die Attraktivität des Angebots für die Nutzer verringern.
. Personalrisiken: Fehlende Expertise oder Ressourcen für den Betrieb des ZT Clusters können zu Personalengpässen führen und die Effizienz des Betriebs beeinträchtigen.
. Wettbewerbsrisiken: Konkurrenzdruck und Marktentwicklungen können die Rentabilität des ZT Clusters beeinträchtigen und die Position des Fachdienstes am Markt gefährden.
